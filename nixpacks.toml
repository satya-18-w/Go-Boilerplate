[phases.setup]
nixPkgs = ["go_1_25", "nodejs_22", "bun"]
aptPkgs = ["git"]

[phases.install]
cmds = [

  "bun install --frozen-lockfile",
  "bun run build --filter=@tasker/openapi --filter=@tasker/zod",
  "cd backend && go mod download"
]

[phases.build]

cmds = [
  # Build shared packages first (zod, openapi)
  "bun run build --filter=@tasker/zod",
  "bun run build --filter=@tasker/openapi",
  "bun run build --filter=@tasker/emails",
  # Build frontend
  "cd frontend && bun run build",
  # Build Go backend
  "cd backend && go build -o ../bin/server ./cmd/go-TODO_TASKER"
]

[start]
cmd = "./bin/server"

# Alternative: Backend-only deployment
# Uncomment below and comment above sections if deploying backend separately
# [phases.setup]
# nixPkgs = ["go_1_25"]
# 
# [phases.install]
# cmds = ["cd backend && go mod download"]
# 
# [phases.build]
# cmds = ["cd backend && go build -o server ./cmd/go-TODO_TASKER"]
# 
# [start]
# cmd = "cd backend && ./server"

# Alternative: Frontend-only deployment
# Uncomment below for frontend-only deployment (serves static files)
# [phases.setup]
# nixPkgs = ["nodejs_22", "bun"]
# 
# [phases.install]
# cmds = ["bun install --frozen-lockfile"]
# 
# [phases.build]
# cmds = [
#   "bun run build --filter=@tasker/zod",
#   "bun run build --filter=@tasker/openapi", 
#   "cd frontend && bun run build"
# ]
# 
# [start]
# cmd = "cd frontend && bun run start"